<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 禁止页面缩放 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>银行排队取号系统</title>
    <style>
        /* 全局禁止文字选中 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', Arial, sans-serif;
            user-select: none; /* 标准属性 */
            -webkit-user-select: none; /* Chrome/Safari/Edge */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE/Edge */
            -webkit-touch-callout: none; /* iOS Safari 禁止长按菜单 */
            -webkit-tap-highlight-color: transparent; /* 消除点击高亮 */
        }
        
        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            background-size: 100% 100%;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            touch-action: none; /* 禁止触摸缩放 */
        }
        
        /* 顶部栏 */
        .top-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 30px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .logo {
            height: 45px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .logo:hover {
            transform: scale(1.03);
        }
        
        .logo-text {
            color: white;
            font-size: 1.6rem;
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .clock-container {
            color: white;
            text-align: right;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }
        
        .time {
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .date {
            font-size: 0.9rem;
            margin-top: 3px;
            opacity: 0.9;
        }
        
        /* 主内容区 */
        .main-content {
            height: calc(100vh - 120px);
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding-top: 70px;
            padding-bottom: 50px;
        }
        
        .container {
            background-color: white;
            background-image: 
                radial-gradient(rgba(44, 82, 130, 0.05) 1px, transparent 1px),
                radial-gradient(rgba(44, 82, 130, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.07);
            width: 90%;
            max-width: 900px;
            padding: 50px;
            text-align: center;
            border: 1px solid rgba(222, 230, 239, 0.8);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        h1 {
            color: #1a365d;
            margin-bottom: 15px;
            font-size: 3rem;
            font-weight: 700;
            letter-spacing: 1px;
            background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
            position: relative;
        }
        
        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 15%;
            width: 70%;
            height: 4px;
            background: linear-gradient(90deg, rgba(44, 82, 130, 0) 0%, rgba(44, 82, 130, 0.6) 50%, rgba(44, 82, 130, 0) 100%);
            border-radius: 2px;
        }
        
        .subtitle {
            color: #4a5568;
            margin-bottom: 50px;
            font-size: 1.3rem;
            letter-spacing: 0.5px;
            line-height: 1.6;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .btn-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            margin: 50px 0;
        }
        
        .btn {
            border: none;
            border-radius: 16px;
            padding: 30px 15px;
            font-size: 1.3rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
            aspect-ratio: 1/1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            -webkit-user-drag: none;
            position: relative;
            overflow: hidden;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(rgba(255,255,255,0.2), rgba(255,255,255,0));
            opacity: 0;
            transition: opacity 0.3s ease;
            transform: translateY(-100%);
            transition: transform 0.5s ease, opacity 0.5s ease;
        }
        
        .btn:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
        
        .btn:hover::before {
            opacity: 1;
            transform: translateY(100%);
        }
        
        .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-personal {
            background: linear-gradient(135deg, #3182ce 0%, #2b6cb0 100%);
            color: white;
        }
        
        .btn-corporate {
            background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
            color: white;
        }
        
        .btn-vip {
            background: linear-gradient(135deg, #805ad5 0%, #6b46c1 100%);
            color: white;
        }
        
        .btn-icon {
            font-size: 3rem;
            margin-bottom: 18px;
            transition: transform 0.3s ease;
        }
        
        .btn:hover .btn-icon {
            transform: scale(1.15);
        }
        
        /* 底部广告栏 */
        .ad-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 55px;
            background: linear-gradient(90deg, #1a365d 0%, #2c5282 100%);
            color: white;
            display: flex;
            align-items: center;
            overflow: hidden;
            z-index: 100;
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .ad-content {
            white-space: nowrap;
            animation: scrollText 40s linear infinite;
            padding-left: 100%;
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 40px;
        }
        
        .ad-content span {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .ad-content .icon {
            font-size: 1.3rem;
        }
        
        @keyframes scrollText {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* 打印弹窗 */
        .print-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .print-content {
            background-color: white;
            border-radius: 16px;
            padding: 40px;
            width: 85%;
            max-width: 500px;
            text-align: center;
            animation: scaleIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(222, 230, 239, 0.8);
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.9); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .print-title {
            font-size: 1.7rem;
            margin-bottom: 30px;
            color: #1a365d;
            font-weight: 600;
            position: relative;
            display: inline-block;
        }
        
        .print-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 10%;
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, rgba(44, 82, 130, 0) 0%, rgba(44, 82, 130, 0.5) 50%, rgba(44, 82, 130, 0) 100%);
            border-radius: 2px;
        }
        
        .print-ticket {
            background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05) inset;
            position: relative;
            overflow: hidden;
        }
        
        .print-ticket::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #3182ce, #ed8936, #805ad5);
        }
        
        .print-number {
            font-size: 3.2rem;
            font-weight: 700;
            margin: 20px 0;
            letter-spacing: 3px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .personal {
            color: #3182ce;
        }
        
        .corporate {
            color: #ed8936;
        }
        
        .vip {
            color: #805ad5;
        }
        
        .print-info {
            margin: 25px 0;
            font-size: 1.1rem;
            color: #4a5568;
            line-height: 1.8;
        }
        
        .print-info p {
            padding: 5px 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        
        .print-info p:last-child {
            border-bottom: none;
        }
        
        .print-message {
            margin-top: 30px;
            color: #64748b;
            font-style: italic;
            font-size: 1rem;
            line-height: 1.6;
            padding: 10px 0;
        }
        
        .print-error {
            color: #e11d48;
            font-weight: 500;
        }
        
        /* 刷卡弹窗 */
        .card-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }
        
        .card-content {
            background-color: white;
            border-radius: 16px;
            padding: 40px;
            width: 85%;
            max-width: 500px;
            text-align: center;
            animation: scaleIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(222, 230, 239, 0.8);
        }
        
        .card-title {
            font-size: 1.7rem;
            margin-bottom: 30px;
            color: #1a365d;
            font-weight: 600;
            position: relative;
            display: inline-block;
        }
        
        .card-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 10%;
            width: 80%;
            height: 3px;
            background: linear-gradient(90deg, rgba(128, 90, 213, 0) 0%, rgba(128, 90, 213, 0.6) 50%, rgba(128, 90, 213, 0) 100%);
            border-radius: 2px;
        }
        
        .card-reader {
            width: 320px;
            height: 280px;
            margin: 25px auto;
            background-color: #f8fafc;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        
        .card-slot {
            width: 80%;
            height: 6px;
            background-color: #64748b;
            border-radius: 3px;
            margin-bottom: 25px;
            position: relative;
        }
        
        .card-slot::before,
        .card-slot::after {
            content: '';
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            z-index: 1;
        }
        
        .card-slot::before {
            left: -8px;
        }
        
        .card-slot::after {
            right: -8px;
        }
        
        .card-icon {
            font-size: 3.5rem;
            color: #64748b;
            margin-bottom: 20px;
            transition: transform 0.5s ease, color 0.5s ease;
        }
        
        .card-instruction {
            color: #4a5568;
            font-size: 1.15rem;
            margin-bottom: 25px;
            font-weight: 500;
        }
        
        .card-progress {
            width: 0;
            height: 5px;
            background: linear-gradient(90deg, #10b981, #059669);
            position: absolute;
            bottom: 0;
            left: 0;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .card-btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .card-btn {
            margin-top: 20px;
            padding: 12px 25px;
            background-color: #64748b;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .card-btn.primary {
            background-color: #805ad5;
        }
        
        .card-btn.cancel {
            background-color: #94a3b8;
        }
        
        /* 刷卡指引样式优化 */
				.card-instruction {
				    color: #4a5568;
				    font-size: 1rem;
				    margin-bottom: 25px;
				    line-height: 1.6;
				    text-align: left;
				    padding: 0 20px;
				}

				.card-instruction div {
				    margin: 5px 0;
				}

				.card-instruction div:first-child {
				    color: #1a365d;
				}
        /* 连接状态指示器 */
        .connection-status {
            position: fixed;
            top: 85px;
            right: 25px;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.95rem;
            font-weight: 500;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .connection-status::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .connected {
            background-color: #10b981;
            color: white;
        }
        
        .connected::before {
            background-color: white;
            animation: pulse 2s infinite;
        }
        
	    /* 修改连接状态指示器样式 */
		.connection-status {
		    position: fixed;
		    top: 85px;
		    right: 25px;
		    padding: 10px 20px;
		    border-radius: 25px;
		    font-size: 0.95rem;
		    font-weight: 500;
		    z-index: 100;
		    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
		    display: none; /* 默认隐藏所有状态 */
		    align-items: center;
		    gap: 8px;
		    animation: slideIn 0.3s ease;
		}

		/* 仅保留断开连接状态的显示样式 */
		.disconnected {
		    background-color: #e11d48;
		    color: white;
		    display: flex; /* 只有断开时显示 */
		}

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .disconnected {
            background-color: #e11d48;
            color: white;
        }
        
        .disconnected::before {
            background-color: white;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        /* 错误弹窗 */
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
            backdrop-filter: blur(5px);
        }
        
        .error-content {
            background-color: white;
            border-radius: 16px;
            padding: 40px;
            width: 85%;
            max-width: 500px;
            text-align: center;
            animation: scaleIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(222, 230, 239, 0.8);
            position: relative;
        }
        
        .error-content::before {
            content: '⚠️';
            font-size: 3rem;
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #fee2e2;
        }
        
        .error-title {
            font-size: 1.8rem;
            margin: 20px 0 30px 0;
            color: #b91c1c;
            font-weight: 600;
        }
        
        .error-message {
            margin: 20px 0 30px 0;
            font-size: 1.15rem;
            color: #4a5568;
            line-height: 1.8;
            padding: 15px;
            background-color: #fee2e2;
            border-radius: 8px;
            border: 1px solid #fecaca;
        }
        
        .error-btn {
            margin-top: 15px;
            padding: 12px 30px;
            background-color: #ef4444;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 500;
        }
        
        /* Toast 通知 */
        .toast {
            position: fixed;
            top: 85px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            padding: 12px 25px;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast-success {
            background-color: #10b981;
        }
        
        .toast-error {
            background-color: #ef4444;
        }
        
        .toast-info {
            background-color: #3b82f6;
        }
        
        .toast-warning {
            background-color: #f59e0b;
        }
        
        .toast-icon {
            font-size: 1.2rem;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .btn-group {
                grid-template-columns: repeat(1, 1fr);
                gap: 20px;
            }
            
            .container {
                padding: 30px 20px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
        }
        
        @media (max-width: 480px) {
            .top-bar {
                padding: 0 15px;
            }
            
            .logo-text {
                font-size: 1.3rem;
            }
            
            .container {
                padding: 25px 15px;
                border-radius: 15px;
            }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <!-- 禁止右键菜单 -->
    <script>
        // 禁止F12开发者工具
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12') {
                e.preventDefault();
            }
            // 禁止Ctrl+Shift+I
            if (e.ctrlKey && e.shiftKey && e.key === 'I') {
                e.preventDefault();
            }
            // 禁止Ctrl+U查看源代码
            if (e.ctrlKey && e.key === 'u') {
                e.preventDefault();
            }
        });
    </script>
    
    <!-- 顶部栏 -->
    <div class="top-bar">
        <div class="logo">
            <svg height="45" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="100" cy="100" r="90" fill="#38bdf8"/>
                <path d="M100 50L125 125H75L100 50Z" fill="white"/>
                <circle cx="100" cy="140" r="20" fill="white"/>
            </svg>
            <span class="logo-text">银行排队系统</span>
        </div>
        <div class="clock-container">
            <div class="time" id="time">00:00:00</div>
            <div class="date" id="date">2023年1月1日 星期一</div>
        </div>
    </div>
    
    <!-- 连接状态指示器 -->
    <div class="connection-status disconnected" id="connectionStatus">
        未连接到服务器
    </div>
    
    <!-- 主内容区 -->
    <div class="main-content">
        <div class="container">
            <h1>银行排队取号</h1>
            <p class="subtitle">请选择您需要办理的业务类型</p>
            
            <div class="btn-group">
                <button class="btn btn-personal" onclick="takeTicket('PERSONAL')">
                    <span class="btn-icon">👤</span>
                    <span>个人业务</span>
                </button>
                <button class="btn btn-corporate" onclick="takeTicket('CORPORATE')">
                    <span class="btn-icon">🏢</span>
                    <span>对公业务</span>
                </button>
                <button class="btn btn-vip" onclick="showCardReader()">
                    <span class="btn-icon">⭐</span>
                    <span>VIP业务</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- 底部广告栏 -->
    <div class="ad-bar">
        <div class="ad-content" id="adContent">
            <span><span class="icon">💰</span>最新理财："稳盈宝"预期年化4.2%，限额发售中！</span>
            <span><span class="icon">💳</span>信用卡优惠：消费满1000元立减50元！</span>
            <span><span class="icon">🏦</span>存款利率：三年期定期上浮至3.5%，欢迎咨询！</span>
        </div>
    </div>
    
    <!-- 打印弹窗 -->
    <div class="print-modal" id="printModal">
        <div class="print-content">
            <div class="print-title">正在打印凭条</div>
            <div class="print-ticket">
                <p>您的排队号码</p>
                <div class="print-number" id="printNumber"></div>
                <div class="print-info">
                    <p>业务类型: <span id="printType"></span></p>
                    <p>取号时间: <span id="printTime"></span></p>
                    <p>当前等候人数: <span id="printWaitingCount"></span></p>
                </div>
            </div>
            <div class="print-message" id="printMessage">请稍等，正在打印...</div>
        </div>
    </div>
    
    <!-- 刷卡弹窗 -->
    <!-- 刷卡弹窗（修改后） -->
		<div class="card-modal" id="cardModal">
		    <div class="card-content">
		        <div class="card-title">VIP身份验证</div>
		        <div class="card-reader">
		            <div class="card-slot"></div>
		            <div class="card-icon">💳</div>
		            <!-- 详细操作指引 -->
		            <div class="card-instruction" id="cardInstruction">
		                <div style="margin-bottom: 8px; font-weight: 600;">请选择以下方式之一验证：</div>
										<div>1. 磁条卡：根据提示刷磁条</div>
										<div>2. 身份证：放置于非接感应区</div>
										<div>3. 非接银行卡：放置于非接感应区</div>
										<div>4. IC卡：根据提示插入IC读卡器</div>
		            </div>
		            <div class="card-progress" id="cardProgress"></div>
		        </div>
		        <div class="card-btn-group">
		            <button class="card-btn primary" onclick="simulateCardSwipe()">模拟验证</button>
		            <button class="card-btn cancel" onclick="closeCardModal()">取消</button>
		        </div>
		    </div>
		</div>
    
    <!-- 错误弹窗 -->
    <div class="error-modal" id="errorModal">
        <div class="error-content">
            <div class="error-title" id="errorTitle">系统错误</div>
            <div class="error-message" id="errorMessage"></div>
            <button class="error-btn" onclick="closeErrorModal()">确定</button>
        </div>
    </div>

    <script>
        // WebSocket配置
        let socket = null;
        const SERVER_URL = "ws://localhost:4321";
        let clientUUID = generateUUID();
        
        // 业务类型映射
        const BUSINESS_TYPE_MAP = {
            PERSONAL: "1",
            CORPORATE: "2",
            VIP: "4"
        };
        
        const TYPE_NAMES = {
            1: "个人业务",
            2: "对公业务",
            4: "VIP业务"
        };
        
        const TYPE_COLORS = {
            1: "personal",
            2: "corporate",
            4: "vip"
        };
        
        const WEEKDAYS = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
        
        // 初始化WebSocket连接
        function initWebSocket() {
            try {
                socket = new WebSocket(SERVER_URL);
                
                socket.onopen = function() {
                    console.log("WebSocket连接已建立");
                    updateConnectionStatus(true);
                    showToast("已成功连接到服务器", "success");
                };
                
                socket.onmessage = function(event) {
                    handleServerMessage(event.data);
                };
                
                socket.onclose = function() {
                    console.log("WebSocket连接已关闭");
                    updateConnectionStatus(false);
                   //  showToast("与服务器断开连接，正在重试...", "error");
                    setTimeout(initWebSocket, 3000);
                };
                
                socket.onerror = function(error) {
                    console.error("WebSocket错误:", error);
                    updateConnectionStatus(false);
                  //  showToast("连接发生错误", "error");
                };
            } catch (error) {
                console.error("初始化WebSocket失败:", error);
                updateConnectionStatus(false);
               // showToast("无法初始化连接", "error");
            }
        }
        
        // 生成UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // 更新连接状态显示
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connectionStatus');
            if (connected) {
                statusElement.textContent = "已连接";
                statusElement.className = "connection-status connected";
				statusElement.style.display = 'none';
            } else {
                statusElement.textContent = "未连接到服务器";
                statusElement.className = "connection-status disconnected";
                statusElement.style.display = "flex";
            }
        }
        
        // 发送取号请求
        function sendTakeNumberRequest(businessType) {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                showError("连接错误", "未连接到服务器，请稍后再试");
                return false;
            }
            
            const param = BUSINESS_TYPE_MAP[businessType];
            if (!param) {
                showError("系统错误", "无效的业务类型");
                return false;
            }
            
            const message = {
                action: "APP_TakeNumber",
                param: param,
                uuid: clientUUID
            };
            
            try {
                socket.send(JSON.stringify(message));
                return true;
            } catch (error) {
                console.error("发送消息失败:", error);
                showError("发送错误", "无法发送请求，请重试");
                return false;
            }
        }

  // 发送取号请求
        function sendAdminRequest() {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                showError("连接错误", "未连接到服务器，请稍后再试");
                return false;
            }          
            
            
            const message = {
                action: "APP_Admin",
                param: "",
                uuid: clientUUID
            };
            
            try {
                socket.send(JSON.stringify(message));
                return true;
            } catch (error) {
                console.error("发送消息失败:", error);
                showError("发送错误", "无法发送请求，请重试");
                return false;
            }
        }        
        // 处理服务端消息
        function handleServerMessage(message) {
            try {
                const data = JSON.parse(message);
                if (!data || !data.action) {
                    console.warn("无效的消息格式:", data);
                    return;
                }
                
                switch(data.action) {
                    case "TAKE_NUMBER_RESPONSE":
                        handleTicketResponse(data);
                        break;
                    case "PRINT_STATUS":
                        handlePrintStatus(data);
                        break;
                    case "CALL_MSG":                    
                        handleCallMsg(data);
                        break;    
                    case "CARD_NUM": 
                        handleCardNum(data);
                        break;     
                    default:
                        console.warn("未知消息类型:", data.action);
                }
            } catch (error) {
                console.error("解析消息失败:", error);
            }
        }
        
        // 处理卡片验证结果
        function handleCardNum(data) {
            const progress = document.getElementById('cardProgress');
            const instruction = document.getElementById('cardInstruction');
            
            instruction.textContent = "正在验证卡片...";
            
            // 模拟刷卡进度
            let width = 0;
            const interval = setInterval(() => {
                width += 50;
                progress.style.width = width + '%';
                
                if (width >= 100) {
                    clearInterval(interval);
                    instruction.textContent = "验证成功！";
                    setTimeout(() => {
                        document.getElementById('cardModal').style.display = 'none';
                        takeTicket('VIP');
                    }, 1000);
                }
            }, 100);
        }
        
        // 处理取号响应
        function handleTicketResponse(data) {
            if (data.success) {
                // 显示票号信息
                showPrintModal(
                    data.ticketNumber || "未知",
                    TYPE_NAMES[data.businessType] || "未知业务",
                    TYPE_COLORS[data.businessType] || "personal",
                    data.waitingCount || 0,
                    new Date(data.timestamp || new Date())
                );
                
                showToast(`取号成功！您的号码：${data.ticketNumber}`, "success");
            } else {
                showError("取号失败", data.message || "未知错误，请重试");
            }
        }
        
        // 处理打印状态
        function handlePrintStatus(data) {
            const messageElement = document.getElementById('printMessage');
            if (data.success == "true") {
                messageElement.textContent = "打印完成，请取走凭条！请留意叫号通知。";
                messageElement.className = "print-message";
                
                setTimeout(() => {
                    document.getElementById('printModal').style.display = 'none';
                    messageElement.textContent = "请稍等，正在打印...";
                }, 3000);
            } else {
                messageElement.textContent = `打印失败: ${data.message || "未知错误，请联系工作人员"}`;
                messageElement.className = "print-message print-error";
                setTimeout(() => {
                    document.getElementById('printModal').style.display = 'none';
                    messageElement.className = "print-message";
                    messageElement.textContent = "请稍等，正在打印...";
                }, 3000);
            }
        }
        
        // 处理叫号信息
        function handleCallMsg(data) {
            if (data.number)
                showToast(`${data.window}号窗口正在呼叫号码: ${data.number}`, "info");
        }
        
        // 显示打印弹窗
        function showPrintModal(ticketNumber, typeName, colorClass, waitingCount, time) {
            const modal = document.getElementById('printModal');
            const numberElement = document.getElementById('printNumber');
            const typeElement = document.getElementById('printType');
            const timeElement = document.getElementById('printTime');
            const waitingElement = document.getElementById('printWaitingCount');
            
            numberElement.textContent = ticketNumber;
            numberElement.className = `print-number ${colorClass}`;
            typeElement.textContent = typeName;
            timeElement.textContent = formatTime(time);
            waitingElement.textContent = waitingCount;
            
            modal.style.display = 'flex';
        }
        
        // 取号功能
        function takeTicket(businessType) {
            // 显示打印弹窗（初始状态）
            const typeName = typeNameMap[businessType] || "未知业务";
            const colorClass = colorClassMap[businessType] || "personal";
            
            showPrintModal(
                "生成中...",
                typeName,
                colorClass,
                "查询中",
                new Date()
            );
            
            // 发送取号请求
            const sent = sendTakeNumberRequest(businessType);
            
            if (!sent) {
                document.getElementById('printModal').style.display = 'none';
            }
        }
        
        // 业务类型映射表
        const typeNameMap = {
            'PERSONAL': '个人业务',
            'CORPORATE': '对公业务',
            'VIP': 'VIP业务'
        };
        
        const colorClassMap = {
            'PERSONAL': 'personal',
            'CORPORATE': 'corporate',
            'VIP': 'vip'
        };
        
        // 显示刷卡界面
        function showCardReader() {
				document.getElementById('cardModal').style.display = 'flex';
				// 初始化详细指引文本
				document.getElementById('cardInstruction').innerHTML = `
				<div style="margin-bottom: 2px; font-weight: 600;">请选择以下方式之一验证：</div>
				<div>1. 磁条卡：根据提示刷磁条</div>
				<div>2. 身份证：放置于非接感应区</div>
				<div>3. 非接银行卡：放置于非接感应区</div>
				<div>4. IC卡：根据提示插入IC读卡器</div>
				`;
				document.getElementById('cardProgress').style.width = '0';
        }
        
        // 模拟刷卡过程
        function simulateCardSwipe() {
            const progress = document.getElementById('cardProgress');
            const instruction = document.getElementById('cardInstruction');
            
            instruction.textContent = "正在验证卡片...";
            
            // 模拟刷卡进度
            let width = 0;
            const interval = setInterval(() => {
                width += 50;
                progress.style.width = width + '%';
                
                if (width >= 100) {
                    clearInterval(interval);
                    instruction.textContent = "验证成功！正在为您取号...";
                    setTimeout(() => {
                        document.getElementById('cardModal').style.display = 'none';
                        takeTicket('VIP');
                    }, 1000);
                }
            }, 100);
        }
        
        // 关闭刷卡界面
        function closeCardModal() {
            document.getElementById('cardModal').style.display = 'none';
        }
        
        // 显示错误弹窗
        function showError(title, message) {
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorModal').style.display = 'flex';
        }
        
        // 关闭错误弹窗
        function closeErrorModal() {
            document.getElementById('errorModal').style.display = 'none';
        }
        
        // 显示Toast通知
        function showToast(message, type = 'info') {
            // 创建toast元素
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            // 设置图标
            let icon = 'ℹ️';
            switch(type) {
                case 'success': icon = '✅'; break;
                case 'error': icon = '❌'; break;
                case 'warning': icon = '⚠️'; break;
                default: icon = 'ℹ️';
            }
            
            toast.innerHTML = `<span class="toast-icon">${icon}</span>${message}`;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
        
        // 格式化时间
        function formatTime(date) {
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }
        
        // 更新时间和日期
        function updateDateTime() {
            const now = new Date();
            
            // 更新时间
            const timeStr = now.toLocaleTimeString('zh-CN', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            document.getElementById('time').textContent = timeStr;
            
            // 更新日期和星期
            const year = now.getFullYear();
            const month = now.getMonth() + 1;
            const day = now.getDate();
            const weekday = WEEKDAYS[now.getDay()];
            
            const dateStr = `${year}年${month}月${day}日 ${weekday}`;
            document.getElementById('date').textContent = dateStr;
        }
        
        // 页面加载完成后初始化
        window.onload = function() {
            initWebSocket();
            updateDateTime();
            setInterval(updateDateTime, 1000);
            
            // 添加logo点击计数器（1秒内5次）
            let logoClickCount = 0;
            let logoClickTimeout = null;
            const logoElement = document.querySelector('.logo');
            const REQUIRED_CLICKS = 5;
            const TIME_WINDOW = 1000;
            
            logoElement.addEventListener('click', function() {
                if (logoClickTimeout) {
                    clearTimeout(logoClickTimeout);
                }
                
                logoClickCount++;
                
                if (logoClickCount >= REQUIRED_CLICKS) {
                    executeSecretFunction();
                    logoClickCount = 0;
                    return;
                }
                
                logoClickTimeout = setTimeout(() => {
                    logoClickCount = 0;
                }, TIME_WINDOW);
            });
        };
        
        // 秘密功能函数
        function executeSecretFunction() {
            console.log("1秒内5次点击触发成功！");
            showToast("🔓 管理员模式已激活", "success");
            
            sendAdminRequest();
            const logo = document.querySelector('.logo');
            logo.style.transform = "scale(1.2) rotate(5deg)";
            logo.style.transition = "all 0.3s ease";
            
            setTimeout(() => {
                logo.style.transform = "scale(1) rotate(0)";
            }, 300);
        }
    </script>
</body>
</html>
